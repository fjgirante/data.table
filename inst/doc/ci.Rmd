---
title: "Continuous Integration for data.table"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    theme: spacelab
    highlight: pygments
    css : ../../vignettes/css/bootstrap.css
---

```{r, echo = FALSE, message = FALSE}
# rendered doc soon available on https://rawgit.com/wiki/Rdatatable/data.table/inst/doc/ci.html
require(data.table)
require(xtable)
knitr::opts_chunk$set(
  comment = "#",
    error = FALSE,
     tidy = FALSE,
    cache = FALSE,
 collapse = TRUE)
```

***

Having Continuous Integration setup for your R package can bring a range of benefits. Generally speaking it is all about `R CMD build` followed by `R CMD check` against your package.  
CI setup can tell you if package build and install successfully, if it is properly structured, and finally, most importantly check if all unit tests are passing.  
This reveals few factors that should be taken into account. One of the most fundamental is to have clean and reproducible environment to process builds. Often you may want to test various environment configuration, for example run build against R-devel version to detect incoming breaking changes in next R release. Alternatively run build on old R release to ensure backward compatibility with older R releases. Not just R versions are important here, if your package depends on PostgreSQL database, you may want to have multiple builds for various postgres versions to ensure the package pass all unit tests on various postgres versions.  
Continuous Integration can be extended into Continuous Delivery by publishing artifacts produced during CI builds for public consumption. In context of R that could be publishing [drat](https://github.com/eddelbuettel/drat/) repository of your package (for easy installing as from CRAN), or rendering documentation into easy to browse html format.  

***

```{r, echo=FALSE, results='hide'}
# all CI metadata
ci = list(
    "travis-ci" = list(
        service = "travis-ci",
        test_purpose = "standard",
        website = c("project-ci" = "https://travis-ci.org/Rdatatable/data.table"),
        os = "ubuntu:12.04",
        image = character(),
        os_image_control = FALSE,
        r_version = "r-release",
        force_suggests = TRUE,
        tests_suggests = "all",
        build_opts = c("--no-build-vignettes","--no-manual"),
        check_opts = c("--no-build-vignettes","--no-manual","--as-cran"),
        build_vignettes = FALSE,
        redundant_pkgs = "a lot of redundant pkgs",
        publish = c(drat = "https://Rdatatable.github.io/data.table", covr = "https://codecov.io/github/Rdatatable/data.table"),
        files_in_repo = c(".travis.yml" = "https://github.com/Rdatatable/data.table/blob/master/.travis.yml", "deploy.sh" = "https://github.com/Rdatatable/data.table/blob/master/deploy.sh")
    ),
    "appveyor" = list(
        service = "appveyor",
        test_purpose = "windows",
        website = c("project-ci" = "https://ci.appveyor.com/project/Rdatatable/data-table"),
        os = "Windows Server 2012",
        image = character(),
        os_image_control = FALSE,
        r_version = "r-release",
        force_suggests = TRUE,
        tests_suggests = "all",
        build_opts = c("--no-manual"),
        check_opts = c("--no-manual","--as-cran","--install-args=--build","--no-multiarch"),
        build_vignettes = FALSE,
        redundant_pkgs = "a lot of redundant pkgs",
        publish = c("raw artifacts" = "https://ci.appveyor.com/project/Rdatatable/data-table/build/artifacts"),
        files_in_repo = c("appveyor.yml" = "https://github.com/Rdatatable/data.table/blob/master/appveyor.yml")
    ),
    "gitlab-ci" = list(
        service = "gitlab-ci",
        test_purpose = "all suggests and no redundant pkgs",
        website = c("project-ci" = "https://gitlab.com/jangorecki/data.table/builds"),
        os = "ubuntu:14.04",
        image = c("jangorecki/r-pkg" = "https://hub.docker.com/r/jangorecki/r-pkg/"),
        os_image_control = TRUE,
        r_version = "r-release",
        force_suggests = TRUE,
        tests_suggests = "all",
        build_opts = character(),
        check_opts = c("--no-manual","--as-cran"),
        build_vignettes = TRUE,
        redundant_pkgs = character(),
        publish = c("drat, manual, vignettes, logs" = "https://jangorecki.gitlab.io/data.table"),
        files_in_repo = c(".gitlab-ci.yml" = "https://gitlab.com/jangorecki/data.table/blob/gl-ci/.gitlab-ci.yml") # update gl-ci to master when merged
    ),
    "gitlab-ci:vanilla" = list(
        service = "gitlab-ci",
        test_purpose = "R vanilla strict zero pkgs",
        website = c("project-ci" = "https://gitlab.com/jangorecki/data.table/builds"),
        os = "ubuntu:14.04",
        image = c("jangorecki/r-base-dev" = "https://hub.docker.com/r/jangorecki/r-base-dev/"),
        os_image_control = TRUE,
        r_version = "r-release",
        force_suggests = FALSE,
        tests_suggests = "none",
        build_opts = character(),
        check_opts = c("--no-manual","--as-cran","--no-build-vignettes"), # replace to `"--ignore-vignettes"` after R 3.3.0
        build_vignettes = FALSE,
        redundant_pkgs = "knitr (< R 3.3.0)", # replace to `character()` after R 3.3.0
        publish = c("drat, manual, logs" = "https://jangorecki.gitlab.io/data.table/vanilla"),
        files_in_repo = c(".gitlab-ci.yml" = "https://gitlab.com/jangorecki/data.table/blob/gl-ci/.gitlab-ci.yml")
    ),
    "gitlab-ci:r-devel" = list(
        service = "gitlab-ci",
        test_purpose = "R devel",
        website = c("project-ci" = "https://gitlab.com/jangorecki/data.table/builds"),
        os = "debian:testing",
        image = c("jangorecki/drd-pkg" = "https://hub.docker.com/r/jangorecki/drd-pkg/"),
        os_image_control = FALSE,
        r_version = "r-devel",
        force_suggests = FALSE,
        tests_suggests = "most",
        build_opts = character(),
        check_opts = c("--no-manual","--as-cran"),
        build_vignettes = TRUE,
        redundant_pkgs = "docopt",
        publish = c("drat, manual, vignettes, logs" = "https://jangorecki.gitlab.io/data.table/r-devel"),
        files_in_repo = c(".gitlab-ci.yml" = "https://gitlab.com/jangorecki/data.table/blob/gl-ci/.gitlab-ci.yml")
    ),
    "gitlab-ci:r-2.15.0" = list(
        service = "gitlab-ci",
        test_purpose = "R 2.15.0 stated dependency",
        website = c("project-ci" = "https://gitlab.com/jangorecki/data.table/builds"),
        os = "ubuntu:14.04",
        image = c("jangorecki/r-2.15.0" = "https://hub.docker.com/r/jangorecki/r-2.15.0/"),
        os_image_control = TRUE,
        r_version = "2.15.0",
        force_suggests = FALSE,
        tests_suggests = "none",
        build_opts = character(),
        check_opts = c("--no-manual","--as-cran"),
        build_vignettes = FALSE,
        redundant_pkgs = character(),
        publish = c("drat, manual, logs" = "https://jangorecki.gitlab.io/data.table/r-2.15.0"),
        files_in_repo = c(".gitlab-ci.yml" = "https://gitlab.com/jangorecki/data.table/blob/gl-ci/.gitlab-ci.yml")
    )
)
```

## CI build matrix

```{r, results='asis', echo=FALSE}
l = lapply(ci, sapply, function(x) {
    if (is.logical(x)) x = c("no", "yes")[x+1L]
    if (length(names(x))) x = sprintf("<a href='%s'>%s</a>", x, names(x))
    paste(x, collapse="<br/>")
})
xt = xtable::xtable(setDF(l, rownames=names(l[[1L]])), align=rep("c", length(l)+1L))
print(xt, type = "html",
      sanitize.text.function = function(x) gsub("--", "&#45;&#45;", x, fixed=TRUE),
      sanitize.rownames.function = function(x) gsub("_", " ", x, fixed=TRUE),
      sanitize.colnames.function = function(x) gsub(":", "<br/>", x, fixed=TRUE))
```

## Fields description

- *image*  
States if some pre-built base image was used.
- *OS/image control*  
States if the OS/image base setup is under control of data.table maintainers.
- *force suggests*  
Reflects `_R_CHECK_FORCE_SUGGESTS_` environment variable. Defines if suggested dependencies are required to perform package check. Some suggested dependencies might not be available for R-devel.
- *tests suggests*  
Describes tested suggested packages.
- *build vignettes*  
States if vignettes are being built during CI. It doesn't directly translates to `R CMD` options, as for example appveyor cuts out `VignetteBuilder` field from `DESCRIPTION` file.
- *redundant pkgs*  
States if redundant packages were present during CI. This may be important as suggested dependencies of `data.table` can have own suggested deps, and their existence in the library might potentially change their behavior and impact `data.table` CI results.
- *publish*  
Location where artifacts of the builds can be accessed.
- *files in repo*  
Files in git repo related to particular CI setup.

## CI dependencies

Following tools have been employed in CI process or when establishing CI configuration.  

- [craigcitro/r-travis](https://github.com/craigcitro/r-travis/) - well known `travis-tool.sh` script.
- [csgillespie/dratTravis](https://github.com/csgillespie/dratTravis) - working example of setting up drat on travis-ci.
- [krlmlr/r-appveyor](https://github.com/krlmlr/r-appveyor/) - used to produce `appveyor.yml` template for appveyor.
- [eddelbuettel/drat](https://github.com/eddelbuettel/drat) - used to publish drat repositories.
- [jangorecki/drat@artifacts](https://github.com/jangorecki/drat/tree/artifacts) - additionally to *drat* master branch it is used to publish manual, vignettes and logs. It also retains support for old R versions, [unlike](https://github.com/eddelbuettel/drat/commit/3350bb97220684fdca0502e71fc151cd9fdb4b2b) *drat* master branch.

## Custom tokens

- travis-ci  
Personal access token for github API used only for publish drat repository into gh-pages branch. It was generated by @jangorecki and it is defined in `.travis.yml` file under `env: global: secure`. See [csgillespie/dratTravis](https://github.com/csgillespie/dratTravis) for details on setting it up.  

## Dirty hacks

- travis-ci  
Publish using gh-pages branch, uses `deploy.sh` and github API secure token. Branch `gh-pages` is always rolled back to the first commit, so gh-pages doesn't grow by keeping history of drat repositories.
- appveyor  
Currently cuts out the `VignetteBuilder` field from `DESCRIPTION` file to avoid building vignettes.

## Adjust CI for forked repos

- travis-ci  
For publishing drat repository to own namespace user need to replace github API token to new one from own account. Then in `.travis.yml` step `after_success` update expected value for variable `$TRAVIS_REPO_SLUG` replacing `Rdatatable/data.table` to `[USERNS]/data.table` and potentially also changing branch `$TRAVIS_BRANCH` variable to your development branch. Also in `deploy.sh` file change the `upstream` remote url from `Rdatatable/data.table.git` to `[USERNS]/data.table` so it will be used as a target for drat repository.
- appveyor  
Looks like it should works out of the box.
- gitlab  
No adjustment are required to run CI. Published content is handled appropriately to each user namespace. Although the published `index.html` display drat *install string* based on `USERNS` variable in `.gitlab-ci.yml`. This only affects the displayed *install string*, not the drat location itself. Can be easy controlled with `variables: USERNS`.

## Acknowledge

- current travis-ci could probably be migrated to [travis container infrastructure](https://blog.rstudio.org/2016/03/09/r-on-travis-ci/).  
- gitlab could also run builds for [windows](https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/install/windows.md) and [osx](https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/install/osx.md) OS, it is a matter of starting a CI runner app on such OS and registering it to your gitlab instance.
- gitlab builds are currently not triggered with every commit, as the pushes to gitlab repo are made on ad-hoc basis.

## CI - FAQ

- way to cancel builds  
Look for *cancel build* button on CI builds website, be aware you still need to have permission to do so.
- way to skip builds  
Put `[ci skip]` string into commit message to suppress build for particular commit - this will work for all CI services. Additionally GitLab CI can skip particular build jobs from CI by prefixing job name in `.gitlab-ci.yml` with a dot, i.e. `.test-r-devel`.
- package binaries from CI are not published  
Yes, that's correct, only package sources are published. Binaries are being built on publically available, no-cost infrastructure. Infrastructure on which we don't have much control, and that raise valid security conserns. I recommend to build `data.table` from source, it builds fast and doesn't have any R dependencies. This way you are actually able to audit the code you are running, which is desired when you rely on public no-cost infrastructure. Windows binaries are produced during build on appveyor anyway and can be found in *Artifacts* as `data.table_1.9.7.zip`. Which can be installed as any other R package binaries with `install.packages("data.table_1.9.7.zip", repos=NULL)`.
- lint validation for CI yaml files  
[travis-ci](http://lint.travis-ci.org/), [gitlab](https://gitlab.com/ci/lint), didn't find any for appveyor.
- build badges  
Badges available as `svg` at [travis-ci](https://travis-ci.org/Rdatatable/data.table.svg?branch=master), [appveyor](https://ci.appveyor.com/api/projects/status/kayjdh5qtgymhoxr/branch/master?svg=true), [gitlab](https://gitlab.com/jangorecki/data.table/badges/master/build.svg).
- browse Rcheck logs of failed build  
All services allows to browse CI log on their websites rendering build logs. `travis-ci` in case of error it prints to main log `cat` of Rcheck output files. It has button *Raw log* which just open full plaintext log. `appveyor` on failure will pack Rcheck files into `failure.zip` and put into *Artifacts* storage. GitLab at the moment lacks of such feature, see [gitlab-ci-multi-runner#990](https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/issues/990) for status on that.  

## Running CI locally

Running CI locally can be sometimes desired, especially when working on confidential projects that cannot be pushed to third parties for CI processing.  
GitLab is an open source project, including its CI engine. Anyone can start own instances of GitLab and GitLab CI runner locally.  
Below workflow to setup local CI uses [docker](https://www.docker.com/) for simplicity. You may need to replace `172.17.0.2` with the proper ip assigned to your image.  

1. run gitlab
2. run ci runner
3. create empty data.table project
4. register ci runner
5. push data.table to local gitlab
6. visit builds in web browser

```sh
# run gitlab: http://doc.gitlab.com/omnibus/docker/

sudo docker run --detach \
    --hostname 172.17.0.2 \
    --publish 443:443 --publish 80:80 --publish 22:22 \
    --name gitlab \
    --volume /srv/gitlab/config:/etc/gitlab \
    --volume /srv/gitlab/logs:/var/log/gitlab \
    --volume /srv/gitlab/data:/var/opt/gitlab \
    gitlab/gitlab-ce:latest

# run ci runner: https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/install/docker.md

docker run -d --name gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /srv/gitlab-runner/config:/etc/gitlab-runner \
  gitlab/gitlab-runner:latest

# create empty data.table project: http://172.17.0.2
# register ci runner: http://doc.gitlab.com/ce/ci/docker/using_docker_images.html
# substitute $token with value from http://172.17.0.2/admin/runners

docker exec -it gitlab-runner gitlab-runner register -n \
    --url "http://172.17.0.2/ci" \
    --executor "docker" \
    --docker-image "ubuntu:14.04" \
    -r "$token"

# push data.table to local gitlab
cd data.table
git remote add local-ci http://172.17.0.2/root/data.table.git
git push local-ci master

# visit builds: http://172.17.0.2/root/data.table/builds
```

Instances can be stopped with `docker stop gitlab gitlab-runner`. Important files from docker images are stored locally in paths defined when calling `docker run`. At later time you can start your existing instances using `docker start gitlab gitlab-runner`.  
If you need to scale your CI you can start more runners and register them. If want to scale to cloud, just spawn instances in cloud and register CI to your GitLab instance. You may also be interested in recent article [GitLab Partners with DigitalOcean to make Continuous Integration faster, safer, and more affordable](https://about.gitlab.com/2016/04/19/gitlab-partners-with-digitalocean-to-make-continuous-integration-faster-safer-and-more-affordable/).  
